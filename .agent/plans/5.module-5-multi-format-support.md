# Module 5: Multi-Format Support

## Context

Modules 1-4 are complete. The ingestion pipeline currently only handles `.txt` files — `fileData.text()` at `ingestion.js:163` assumes plain text encoding. Module 5 adds PDF, DOCX, HTML, and Markdown support using **docling-serve** (Docker container) called via HTTP from Node.js.

Cascade deletes already work (`ingestion.js:126`, migration `00002` has `on delete cascade`).

**Complexity:** ⚠️ **Medium**

---

## Architecture Decision: Docling-Serve via HTTP

- Run `docling-serve` as a Docker container on port 5001
- Call its `/v1/convert/file` REST endpoint directly using `fetch` (Node 18+ built-in)
- `.txt` and `.md` files bypass docling entirely (direct `buffer.toString('utf-8')`)
- No npm SDK dependency needed — raw HTTP is simpler and avoids version coupling

---

## Tasks

### Task 1: Docker Configuration for docling-serve

**Create:** `docker-compose.yml` (project root)

Add a compose file with a single `docling-serve` service:
- Image: `ds4sd/docling-serve:latest` (or `quay.io/docling-project/docling-serve`)
- Port mapping: `5001:5001`
- Restart policy: `unless-stopped`
- Environment: enable CORS

**Modify:** `.env.example` — add `DOCLING_SERVE_URL=http://localhost:5001`

**Validate:** `docker compose up -d` then `curl http://localhost:5001/docs` returns Swagger UI.

---

### Task 2: Create Parsing Library

**Create:** `server/lib/parsing.js`

Export `parseDocument(buffer, filename, mimeType) → Promise<string>`:

1. **Direct text path** — if mimeType is `text/plain` or `text/markdown` (or filename ends `.txt`/`.md`): return `buffer.toString('utf-8')`
2. **Docling path** — if mimeType is PDF/DOCX/HTML (or filename matches `.pdf`/`.docx`/`.html`/`.htm`):
   - Build `FormData` with file blob
   - `POST` to `${DOCLING_SERVE_URL}/v1/convert/file`
   - Extract markdown text from response JSON
   - Throw on non-200 response
3. **Fallback** — unknown types: attempt direct text with a warning log

Also export `SUPPORTED_EXTENSIONS = ['.txt', '.md', '.pdf', '.docx', '.html', '.htm']`

Env var: `DOCLING_SERVE_URL` (default `http://localhost:5001`)

**Pattern reference:** Follow `server/lib/metadata.js` structure (async export function, error throwing, logging).

**Note:** The exact response shape from docling-serve needs verification against the running container. Build `extractTextFromDoclingResponse()` to handle multiple possible shapes gracefully.

**Validate:** Unit tests (Task 5).

---

### Task 3: Update Ingestion Pipeline

**Modify:** `server/routes/ingestion.js`

**3a. Add import** (top of file, after line 7):
```js
import { parseDocument } from '../lib/parsing.js';
```

**3b. Increase file size limit** (line 10): `10 * 1024 * 1024` → `50 * 1024 * 1024`

**3c. Pass mimetype to processDocument** (line 85):
```js
processDocument(docId, userId, storagePath, mimetype).catch(...)
```

**3d. Update function signature** (line 148):
```js
async function processDocument(docId, userId, storagePath, fileType) {
```

**3e. Replace `fileData.text()` with parsing** (line 163):
```js
const arrayBuffer = await fileData.arrayBuffer();
const buffer = Buffer.from(arrayBuffer);
const filename = storagePath.split('/').pop();
const text = await parseDocument(buffer, filename, fileType);
```

**Validate:** Upload a `.txt` file — works identically. Upload a `.pdf` — parsed via docling-serve.

---

### Task 4: Update Frontend File Upload

**Modify:** `client/src/components/FileUpload.jsx`

**4a. Replace file validation** (lines 15-18):
```js
const SUPPORTED_EXTENSIONS = ['.txt', '.md', '.pdf', '.docx', '.html', '.htm'];
const ext = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
if (!SUPPORTED_EXTENSIONS.includes(ext)) {
  alert(`Unsupported file type. Supported: ${SUPPORTED_EXTENSIONS.join(', ')}`);
  return;
}
```

**4b. Update accept attribute** (line 72): `.txt` → `.txt,.md,.pdf,.docx,.html,.htm`

**4c. Update drop zone text** (line 67): `'Drop a .txt file here or click to upload'` → `'Drop a file here or click to upload (PDF, DOCX, TXT, MD, HTML)'`

**Validate:** Browser — file picker shows all formats, unsupported extension shows alert.

---

### Task 5: Unit Tests for Parsing Library

**Create:** `server/tests/unit/parsing.test.js`

Mock `global.fetch` to test:
- `.txt` → direct text, no fetch call
- `.md` → direct text, no fetch call
- `.pdf` → calls docling-serve, returns parsed content
- `.docx` → calls docling-serve, returns parsed content
- `.html` → calls docling-serve, returns parsed content
- Docling error (500 response) → throws descriptive error
- Unknown MIME type → falls back to direct text
- Filename extension fallback when MIME is `application/octet-stream`

**Validate:** `cd server && npm test`

---

### Task 6: Update Integration Tests

**Modify:** `server/tests/integration/ingestion.test.js`

**6a. Mock the parsing library:**
```js
vi.mock('../../lib/parsing.js', () => ({
  parseDocument: vi.fn().mockResolvedValue('parsed content'),
  SUPPORTED_EXTENSIONS: ['.txt', '.md', '.pdf', '.docx', '.html', '.htm'],
}));
```

**6b. Update download mock** in `beforeEach`: change from `{ text: vi.fn() }` to `{ arrayBuffer: vi.fn().mockResolvedValue(new ArrayBuffer(11)) }` — this affects ALL existing tests that trigger `processDocument`.

**6c. Add multi-format test cases:**
- Upload PDF → `parseDocument` called with correct args → document completes
- Parsing failure → document status set to 'error'

**6d. Update `processDocument` call sites** in existing test helpers to include `fileType` parameter.

**Critical:** Ensure all 44+ existing tests still pass after mock changes.

**Validate:** `cd server && npm test` — all tests green.

---

### Task 7: Update PROGRESS.md

Add Module 5 completion status.

---

## File Summary

| File | Action |
|------|--------|
| `docker-compose.yml` | Create |
| `.env.example` | Modify |
| `server/lib/parsing.js` | Create |
| `server/routes/ingestion.js` | Modify |
| `client/src/components/FileUpload.jsx` | Modify |
| `server/tests/unit/parsing.test.js` | Create |
| `server/tests/integration/ingestion.test.js` | Modify |
| `PROGRESS.md` | Modify |

## Execution Order

1 → 2 → 3 → 4 → 5 → 6 → 7

(Tasks 2+4 are independent and can run in parallel; Tasks 5+6 are independent and can run in parallel)

## Verification

1. `cd server && npm test` — all tests pass
2. `docker compose up -d` — docling-serve running on :5001
3. Upload `.txt` file — works as before (no docling call)
4. Upload `.pdf` file — parsed, chunked, status reaches `completed`
5. Upload `.docx` / `.html` / `.md` — same
6. Frontend file picker shows all formats
7. Unsupported extension → alert

## Risks

1. **docling-serve response format** — exact JSON shape needs verification against running container. Mitigated by flexible `extractTextFromDoclingResponse()`.
2. **Existing test breakage** — changing `.text()` → `.arrayBuffer()` mock affects all integration tests. Must update `beforeEach` carefully.
3. **docling-serve unavailable** — `.txt`/`.md` still work without it. PDF/DOCX/HTML get `error` status with message. User can retry after starting container.
