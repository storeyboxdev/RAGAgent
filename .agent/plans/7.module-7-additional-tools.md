# Module 7: Additional Tools (Text-to-SQL + Web Search)

## Context

The chat agent currently has one tool: `search_documents`. Module 7 adds two more — `query_database` for structured SQL queries against the document collection, and `web_search` as a fallback when documents don't have the answer. This teaches multi-tool routing, structured vs unstructured data, graceful fallbacks, and attribution.

**Complexity:** ⚠️ Medium

---

## Tasks

### Task 1: Database Migration — Read-Only Query RPC

**Create:** `supabase/migrations/00007_readonly_query.sql`

Postgres function `execute_readonly_query(query_text, query_user_id)` that:
- Only allows SELECT statements (rejects INSERT/UPDATE/DELETE/DROP/etc.)
- Hard-limits results to 50 rows
- Returns results as JSONB
- `SECURITY DEFINER` so it can run the dynamic SQL

**Validate:** `supabase db reset` applies cleanly.

---

### Task 2: SQL Query Validation Library

**Create:** `server/lib/sql-query.js`

Three exports:

- **`validateAndRewriteQuery(sql, userId)`** — Safety layer:
  - SELECT-only enforcement
  - Block dangerous keywords (INSERT, UPDATE, DELETE, DROP, ALTER, etc.)
  - Whitelist tables: only `documents` and `document_chunks` allowed
  - Auto-inject `user_id = '<userId>'` filter into WHERE clause
  - Returns `{ valid, rewrittenSql?, error? }`

- **`getSchemaDescription()`** — Returns string describing queryable tables/columns for the LLM system prompt (documents + document_chunks, no user_id exposed)

- **`executeQuery(sql, userId)`** — Validates, rewrites, calls `supabaseAdmin.rpc('execute_readonly_query')`, returns `{ rows, rowCount, sql }`

**Validate:** Unit tests (Task 7).

---

### Task 3: Web Search Client Library

**Create:** `server/lib/web-search.js`

Two exports:

- **`isWebSearchEnabled()`** — Returns true if `WEB_SEARCH_ENABLED=true` and required API key is set

- **`webSearch(query, { maxResults })`** — Calls search API, returns normalized `[{ title, url, snippet, score }]`
  - Tavily provider (default): POST to `api.tavily.com/search`
  - SearXNG provider: GET to `<SEARXNG_URL>/search?format=json`
  - Graceful degradation: returns `[]` on any error (network, bad status, timeout)
  - 10s timeout via AbortController

Env vars: `WEB_SEARCH_ENABLED`, `WEB_SEARCH_PROVIDER`, `TAVILY_API_KEY`, `SEARXNG_URL`

**Validate:** Unit tests (Task 8).

---

### Task 4: Update Chat Route — Multi-Tool Agent

**Modify:** `server/routes/chat.js`

Key changes:

1. **Dynamic system prompt** — Replace static `SYSTEM_PROMPT` with `buildSystemPrompt()` that includes:
   - Existing document search instructions
   - Schema description from `getSchemaDescription()` for SQL tool
   - Web search instructions (only when enabled)
   - Routing guidance: document content → search_documents, analytical/collection questions → query_database, general knowledge → web_search

2. **`query_database` tool** — LMStudio `tool()` with `sql` param, emits `tool_call`/`tool_result` SSE events with `{ rows, rowCount, sql, error? }`

3. **`web_search` tool** — LMStudio `tool()` with `query` param, emits SSE events with `{ results }`

4. **Dynamic tools array** — Always includes `search_documents` + `query_database`; adds `web_search` only when `isWebSearchEnabled()` returns true

**Validate:** Existing chat tests still pass. New tests in Task 9.

---

### Task 5: Environment Config

**Modify:** `.env.example`

Add Module 7 section:
```
WEB_SEARCH_ENABLED=false
WEB_SEARCH_PROVIDER=tavily
TAVILY_API_KEY=
SEARXNG_URL=http://localhost:8080
```

---

### Task 6: Frontend Updates

**Modify:** `client/src/components/ToolCallIndicator.jsx`

Refactor into dispatcher with three views:

- **`SearchToolView`** — Extracted from current code (Search icon, chunks, SearchModeBadge)
- **`SqlToolView`** — Database icon, shows "Querying database..." → "Returned N rows", expandable SQL + results table; error state in red
- **`WebSearchToolView`** — Globe icon, shows "Searching the web..." → "Found N web results", expandable results with clickable title links + snippets

**Modify:** `client/src/pages/ChatPage.jsx` (line ~80)

Generalize `tool_result` handler — replace `!updated[i].chunks` check with `!updated[i].completed` flag, and merge all result fields generically:
```js
const { type, name, ...resultData } = data;
updated[i] = { ...updated[i], ...resultData, completed: true };
```

---

### Task 7: Unit Tests — SQL Query Validation

**Create:** `server/tests/unit/sql-query.test.js`

~17 tests covering:
- Valid SELECT passes; INSERT/UPDATE/DELETE/DROP rejected
- Disallowed tables rejected (auth.users, threads, storage.objects)
- Allowed tables pass (documents, document_chunks, JOIN of both)
- user_id filter injected when missing, preserved when present
- Trailing semicolons stripped, case-insensitive handling
- getSchemaDescription returns expected schema string
- executeQuery calls RPC with rewritten SQL; throws on invalid SQL

---

### Task 8: Unit Tests — Web Search Client

**Create:** `server/tests/unit/web-search.test.js`

~11 tests covering:
- isWebSearchEnabled returns false by default, true when configured, false without API key
- Tavily: correct URL/headers/body, response mapping, error handling (network, non-200)
- SearXNG: correct URL, response mapping
- maxResults parameter respected

---

### Task 9: Integration Tests — New Tool SSE Events

**Modify:** `server/tests/integration/chat.test.js`

Add mocks for `sql-query.js` and `web-search.js`. New test cases:
1. `query_database` emits correct tool_call + tool_result SSE events
2. `query_database` emits error on invalid SQL
3. `web_search` emits correct SSE events (when enabled)
4. `web_search` tool not registered when disabled
5. All three tools available when web search enabled
6. Existing search_documents tests still pass (regression)

---

### Task 10: Update PROGRESS.md

Add Module 7 section with all tasks marked complete.

---

## Files Summary

| File | Action |
|------|--------|
| `supabase/migrations/00007_readonly_query.sql` | Create |
| `server/lib/sql-query.js` | Create |
| `server/lib/web-search.js` | Create |
| `server/routes/chat.js` | Modify |
| `.env.example` | Modify |
| `client/src/components/ToolCallIndicator.jsx` | Modify |
| `client/src/pages/ChatPage.jsx` | Modify |
| `server/tests/unit/sql-query.test.js` | Create |
| `server/tests/unit/web-search.test.js` | Create |
| `server/tests/integration/chat.test.js` | Modify |
| `PROGRESS.md` | Modify |

## Execution Order

Task 1 → Tasks 2+3 (parallel) → Task 4 → Task 5 → Task 6 → Tasks 7+8+9 (parallel) → Task 10

## Verification

1. `supabase db reset` — migration applies cleanly
2. `cd server && npm test` — all tests pass
3. Chat "How many documents have I uploaded?" → triggers `query_database`, shows SQL + table
4. Chat "What is in my docs about X?" → triggers `search_documents` (routing works)
5. With `WEB_SEARCH_ENABLED=true` + API key, chat "What is quantum computing?" → triggers `web_search`, shows clickable sources
6. With web search disabled, same question gracefully handled without web_search tool
7. SQL injection attempts ("DROP TABLE documents") → rejected with validation error
8. user_id filter always injected — users can't query other users' data
